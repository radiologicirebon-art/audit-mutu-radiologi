<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Audit Mutu Foto Thoraks</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial,sans-serif;background:#f4f6f9;margin:0}
header{background:#0d6efd;color:white;padding:15px;text-align:center}
nav{display:flex;background:#fff;border-bottom:1px solid #ddd}
nav button{flex:1;padding:12px;border:none;background:#fff;cursor:pointer;font-weight:bold}
nav button.active{background:#0d6efd;color:white}
section{padding:15px}
.card{background:white;padding:15px;border-radius:6px;margin-bottom:15px}
table{width:100%;border-collapse:collapse}
table th,table td{border:1px solid #ddd;padding:8px;text-align:center}
table th{background:#f0f0f0}
input,textarea,select{width:100%;padding:6px;margin-top:4px}
button.submit{background:#198754;color:white;border:none;padding:12px;width:100%;font-size:16px;border-radius:6px;cursor:pointer}
.stat{display:flex;gap:10px}
.stat div{flex:1;background:white;padding:15px;border-radius:6px;text-align:center}
.smallBtn{background:#198754;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer}
</style>
</head>

<body>
<header><h2>AUDIT MUTU FOTO THORAKS</h2></header>

<nav>
<button class="active" onclick="showTab('input',this)">üìù Input Audit</button>
<button onclick="showTab('dashboard',this)">üìä Dashboard Mutu</button>
</nav>

<section id="input">
<form id="auditForm">
<div class="card">
<h3>A. Identitas Pemeriksaan</h3>
<label>Pasien</label>
<input type="text" id="pasien" required>
<label>Tanggal Lahir</label>
<input type="date" id="tgl_lahir" required>
<label>Radiografer</label>
<select id="radiografer" required>
<option value="">-- pilih --</option>
<option>Ino Hadiwinata, A.Md.Rad</option>
<option>Lalan Permana Herlambang, A.Md.Rad</option>
<option>Feby Fardianto, A.Md.Rad</option>
<option>Elis Mandalasari, A.Md.Rad</option>
<option>Argo Nur Pujianto</option>
<option>Tikha Kania, A.Md.Rad</option>
<option>Ipu Yoga Pradetza, A.Md.Rad</option>
<option>Sri Cahyati, A.Md.Rad</option>
<option>Opan Sopandi, A.Md.Rad</option>
<option>Mohamad Vinggih Hernanda, A.Md.Rad</option>
<option>Fahmi Puja Ashri, A.Md.Rad</option>
<option>Gilang Nurgianti Fadilah, A.Md.Rad</option>
<option>Ardi Pratama Oktafiansyah, A.Md.Rad</option>
<option>Zhafira Nur Hasanah, A.Md.Rad</option>
<option>Dwi Alfi Pramesti, A.Md.Rad</option>
<option>Rita Riana, A.Md.Rad</option>
<option>Muhammad Rizky Maulana, A. Md. Kes.</option>
<option>Muhammad Rafi Azhar, A. Md. Kes</option>
<option>Dias Riyandi, A.Md. Kes</option>
<option>Mochamad Taufik H, A.Md. Kes</option>
<option>Arief Maulana, A.Md. Kes</option>
<option>Salsa Dea Charira, A.Md. Kes</option>
</select>
</div>

<div class="card" id="penilaianBox"></div>
<button class="submit">üíæ Simpan Audit</button>
</form>
</section>

<section id="dashboard" style="display:none">
<div class="stat">
<div><h3 id="total">0</h3>Total</div>
<div><h3 id="baik">0</h3>Baik</div>
<div><h3 id="cukup">0</h3>Cukup</div>
<div><h3 id="kurang">0</h3>Kurang</div>
</div>

<div class="card">
<table id="table"></table>
</div>
<canvas id="chart"></canvas>
</section>

<script>
function showTab(tab,btn){
  document.getElementById("input").style.display = tab==='input'?'block':'none';
  document.getElementById("dashboard").style.display = tab==='dashboard'?'block':'none';
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

const kriteria={
"Posisi & Rotasi":["Proyeksi sesuai indikasi","Tidak ada rotasi","Klavikula simetris","Skapula keluar lapang paru"],
"Inspirasi":["Inspirasi adekuat","‚â•10 iga posterior terlihat","Paru mengembang optimal"],
"Exposure":["Vertebra torakal tampak samar","Marking vaskular jelas","Tidak under-exposed","Tidak over-exposed","Detail tulang terlihat"],
"Cakupan Anatomi":["Apeks paru masuk","Costophrenicus terlihat","Dinding toraks lateral masuk"],
"Artefak":["Tidak ada motion","Batas jantung jelas","Tidak ada artefak","Marker R/L benar"]
};

const box=document.getElementById('penilaianBox');
let html='<h3>B. Penilaian Teknis</h3>';
Object.entries(kriteria).forEach(([judul,list])=>{
 html+=`<b>${judul}</b><table><tr><th>Kriteria</th><th>Ya</th><th>Tidak</th></tr>`;
 list.forEach((i,idx)=>{const key=(judul+'_'+idx).replace(/[^a-zA-Z0-9_]/g,'_'); html+=`<tr><td>${i}</td><td><input type='radio' data-label='${i}' name='${key}' value='Ya' required></td><td><input type='radio' data-label='${i}' name='${key}' value='Tidak' required></td></tr>`});
 html+='</table><br>';
});
box.innerHTML=html;

firebase.initializeApp({databaseURL:"https://auditmutu-radiologi-default-rtdb.asia-southeast1.firebasedatabase.app/"});
const db=firebase.database();

function kesimpulan(score){return score>=80?'Mutu baik':score>=60?'Mutu cukup':'Mutu kurang';}

document.getElementById('auditForm').addEventListener('submit',e=>{
 e.preventDefault();
 let total=0,ya=0,detail=[];
 document.querySelectorAll("input[type=radio]:checked").forEach(r=>{total++;if(r.value==='Ya')ya++;detail.push({id:r.name,label:r.dataset.label,value:r.value});});
 const score=Math.round((ya/total)*100);
 db.ref('audit').push({pasien:pasien.value,tgl_lahir:tgl_lahir.value,radiografer:radiografer.value,score:score,kesimpulan:kesimpulan(score),detail:detail,tanggal_simpan:Date.now()});
 alert('Tersimpan | '+score+'%');
 e.target.reset();
});

function printAudit(key){
 db.ref('audit/'+key).once('value').then(snap=>{
   const d=snap.val();
   let detailHTML='';
   d.detail.forEach(item=>{
     detailHTML+=`<tr><td style="padding:4px 8px">${item.label}</td><td style="padding:4px 8px">${item.value}</td></tr>`;
   });

   const tanggalObj=new Date(d.tanggal_simpan||Date.now());
   const tanggal=tanggalObj.toLocaleDateString('id-ID',{day:'2-digit',month:'long',year:'numeric'});
   const jam=tanggalObj.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit',hour12:false})+' WIB';

   const win=window.open('','','width=900,height=700');
   win.document.write(`
   <html>
   <head>
   <title>Bukti Audit</title>
   <style>
     body{font-family:Arial;padding:40px;color:#000}
     h2{text-align:center;margin-bottom:0}
     h4{text-align:center;margin-top:5px;margin-bottom:30px}
     table{width:100%;border-collapse:collapse}
     td{vertical-align:top}
     .info td{padding:4px 8px}
     .kriteria{margin-top:15px}
     .kriteria th{border-bottom:1px solid #000;text-align:left;padding:6px 8px}
     .kriteria td{padding:4px 8px}
     .score{margin-top:20px;font-weight:bold}
     .ttd{margin-top:80px;width:100%}
     .ttd td{text-align:left;padding-top:40px}
   </style>
   </head>
   <body>

   <h2>BUKTI AUDIT MUTU FOTO THORAKS</h2>
   <h4>Instalasi Radiologi</h4>

   <table class="info">
     <tr><td width="180">Nama Pasien</td><td>: ${d.pasien}</td></tr>
     <tr><td>Tanggal Lahir</td><td>: ${d.tgl_lahir}</td></tr>
     <tr><td>Radiografer</td><td>: ${d.radiografer}</td></tr>
   </table>

   <table class="kriteria">
     <tr><th width="70%">Kriteria</th><th>Hasil</th></tr>
     ${detailHTML}
   </table>

   <div class="score">
     SCORE : ${d.score}%<br>
     ${d.kesimpulan.toUpperCase()}
   </div>

   <br><br><br>

   <table class="ttd">
     <tr>
       <td width="60%"></td>
       <td>Cirebon, ${tanggal} ${jam}</td>
     </tr>
     <tr>
       <td></td>
       <td>Petugas Audit</td>
     </tr>
     <tr>
       <td></td>
       <td><br><br><br>
       Ino Hadiwinata, A.Md.Rad<br>
       Koordinator Instalasi Radiologi
       </td>
     </tr>
   </table>

   </body>
   </html>`);

   win.document.close();
   win.focus();
   win.print();
 });
}

let chart;
db.ref('audit').on('value',snap=>{
 let t=0,b=0,c=0,k=0,per={};
 table.innerHTML='<tr><th>Pasien</th><th>Radiografer</th><th>Score</th><th>Kesimpulan</th><th>Cetak</th></tr>';
 snap.forEach(s=>{let d=s.val();let key=s.key;t++;if(d.kesimpulan==='Mutu baik')b++;if(d.kesimpulan==='Mutu cukup')c++;if(d.kesimpulan==='Mutu kurang')k++;
 if(!per[d.radiografer])per[d.radiografer]=[];per[d.radiografer].push(d.score);
 const tgl=new Date(d.tanggal_simpan||0).toLocaleDateString('id-ID',{day:'2-digit',month:'2-digit',year:'numeric'});
 const jm=new Date(d.tanggal_simpan||0).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit',hour12:false});
 table.innerHTML+=`<tr><td>${d.pasien}</td><td>${d.radiografer}</td><td>${tgl}</td><td>${jm}</td><td>${d.score}%</td><td>${d.kesimpulan}</td><td><button class="smallBtn" onclick="printAudit('${key}')">üñ® Cetak</button></td></tr>`});
 total.textContent=t;baik.textContent=b;cukup.textContent=c;kurang.textContent=k;
 const labels=Object.keys(per);const data=labels.map(r=>Math.round(per[r].reduce((a,b)=>a+b,0)/per[r].length));
 if(chart)chart.destroy();chart=new Chart(document.getElementById('chart'),{type:'bar',data:{labels:labels,datasets:[{label:'Rata-rata Score',data:data}]}});
});
</script>
</body>
</html>
